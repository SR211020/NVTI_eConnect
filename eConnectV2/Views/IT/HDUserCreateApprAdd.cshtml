@model eConnectV2.ViewModels.ITViewModel
@{
    Layout = "~/Views/Shared/_Layout2.cshtml";
    ViewData["Title"] = "Help Desk";
    ViewData["HeaderTitle"] = "Help Desk for Approval";
    var Mode = ViewBag.TagAttribute;
}
@section HeadBlock {
    <link rel="stylesheet" media="screen, print" href="~/css/formplugins/bootstrap-datepicker/bootstrap-datepicker.css">
}


<div class="panel">
    <div class="panel-hdr bg-primary-800 min-height-reset height-3">
        @if (ViewBag.Login == "Y")
        {
            @if (ViewBag.RUrl == "UserCreateView")
            {
                <a title="Back" href="@Url.Action("HDUserCreateView", "IT")" style="color:#fff">
                    <i class="fa fa-angle-double-left"></i> Back
                </a>
            }

            else
            {
                <a title="Back" href="@Url.Action("HDUserCreateReport", "IT")" style="color:#fff">
                    <i class="fa fa-angle-double-left"></i> Back
                </a>
            }
        }
        else
        {
            <a title="Back" href="@Url.Action("Index", "Account")" style="color:#fff">
                <i class="fa fa-angle-double-left"></i> Back
            </a>
        }
        <h2 class="justify-content-center">
            <span class="fw-300 pr-1"> UserId Create </span> Approver
        </h2>
    </div>
    <div class="panel-container show">
        <div class="panel-content">
            <div class="row">
                <input asp-for="Plant" hidden/>
                <input asp-for="EmpCode" hidden/>
                <input asp-for="EmpName" hidden/>
                <input asp-for="UserID" hidden/>
                <input asp-for="IdType" hidden />
                <input asp-for="ReqFor" hidden />
                <input asp-for="EmpName2" hidden />
                <input asp-for="EmpCode2" hidden />
                <input asp-for="Status" hidden />
                <input asp-for="ApprID" hidden />
                <input asp-for="ApprType" hidden />
                <div class="col-md-12">
                    <div class="row">
                        <div class="col-md-4">
                            <div class="form-group row">
                                <label class="col-sm-4 col-form-label font-weight-bold">Request No</label>
                                <span class="col-sm-8 col-form-label text-info">@Model.RequestNo</span>
                                <input asp-for="RequestNo" value="@Model.RequestNo" hidden />
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="form-group row">
                                <label class="col-sm-4 col-form-label font-weight-bold">Status</label>
                                <span class="col-sm-8 col-form-label text-info font-weight-normal">@Model.StatusDescr</span>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="form-group row">
                                <label class="col-sm-4 col-form-label font-weight-bold">ID Type</label>
                                <span class="col-sm-8 col-form-label text-info font-weight-normal">@Model.IdType</span>
                            </div>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-4">
                            <div class="form-group row">
                                <label class="col-sm-4 col-form-label font-weight-bold">Request Date</label>
                                <span class="col-sm-8 col-form-label text-info font-weight-normal">@Model.TDate</span>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="form-group row">
                                <label class="col-sm-4 col-form-label font-weight-bold">Email Id</label>
                                <span class="col-sm-8 col-form-label text-info font-weight-normal">@Model.Email</span>
                            </div>
                        </div>
                        <div id="div_EmailAccess" class="col-md-4">
                            <div class="form-group row">
                                <label class="col-sm-4 col-form-label font-weight-bold">External Email Access required ?</label>
                                <div class="col-sm-6">
                                    <div class="form-check form-check-inline row">
                                        <input id="EmailAccess1" asp-for="EmailAccess" class="form-check-input rdEmail" type="radio" value="Y">
                                        <label for="EmailAccess1" class="form-check-label text-success font-weight-bold mr-2">Yes</label>
                                        <input id="EmailAccess2" asp-for="EmailAccess" class="form-check-input rdEmail" type="radio" value="N">
                                        <label for="EmailAccess2" class="form-check-label text-info font-weight-bold mr-2">No</label>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-4">
                            <div class="form-group row">
                                <label class="col-sm-4 col-form-label font-weight-bold">Requestor</label>
                                <span class="col-sm-8 col-form-label text-info font-weight-normal">@Model.EmpCode - @Model.EmpName</span>
                            </div>
                        </div>

                        <div class="col-md-4">
                            <div class="form-group row">
                                <label class="col-sm-4 col-form-label font-weight-bold">Contact No</label>
                                <span class="col-sm-8 col-form-label text-info font-weight-normal">@Model.ContactNo</span>
                            </div>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-4">
                            <div class="form-group row">
                                <label class="col-sm-4 col-form-label font-weight-bold">Department</label>
                                <span class="col-sm-8 text-info font-weight-normal pt-2">@Model.DeptName</span>
                            </div>
                        </div>

                    </div>
                    <div class="row">
                        <div class="col-md-4" id="div_reqFor">
                            <div class="form-group row">
                                <label class="col-sm-4 col-form-label font-weight-bold">Request For</label>
                                <div class="col-sm-8">
                                    <div class="form-check form-check-inline row">
                                        <input id="ReqFor1" asp-for="ReqFor" class="form-check-input rdReqFor" type="radio" value="Self">
                                        <label for="ReqFor1" class="form-check-label text-success font-weight-bold mr-2">Self</label>
                                        <input id="ReqFor2" asp-for="ReqFor" class="form-check-input rdReqFor" type="radio" value="Others">
                                        <label for="ReqFor2" class="form-check-label text-info font-weight-bold mr-2">Others</label>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div id="div_EmpCode" class="col-md-4">
                            <div class="form-group row">
                                <label class="col-sm-4 col-form-label font-weight-bold">Employee Code</label>
                                <div class="col-sm-6">
                                    <input asp-for="EmpCode2" value="@Model.EmpCode2" class="form-control-alternate" type="text" autocomplete="off" disabled>
                                </div>
                            </div>
                        </div>
                        <div id="div_EmpName" class="col-md-4">
                            <div class="form-group row">
                                <label class="col-sm-4 col-form-label font-weight-bold">Employee Name</label>
                                <div class="col-sm-7">
                                    <input asp-for="EmpName2" value="@Model.EmpName2" class="form-control-alternate" type="text" autocomplete="off" disabled>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="row pt-2">
                        <div class="col-md-8">
                            <div class="form-group row">
                                <label class="col-sm-2 col-form-label font-weight-bold">Roles</label>
                                <div class="col-sm-10">
                                    <textarea asp-for="Roles" class="form-control" type="text" rows="3" disabled></textarea>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="row pt-2">
                        <div class="col-md-8">
                            <div class="form-group row">
                                <label class="col-sm-2 col-form-label font-weight-bold">Description</label>
                                <div class="col-sm-10">
                                    <textarea asp-for="Descr1" class="form-control" type="text" rows="5" disabled></textarea>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="row pt-2">
                        <div class="col-md-8">
                            <div id="divStatus" class="form-group row" style="display:none">
                                <label class="col-sm-2 col-form-label font-weight-bold">Status<span class="text-danger ml-1">*</span></label>
                                <div class="col-sm-10 form-check form-check-inline row">
                                    <input id="1" asp-for="ApprStatus" value="APPROVE" class="form-check-input rdApprove" type="radio" onchange="ApprStatus_Change(this)" style="display:none">
                                    <label for="1" class="form-check-label text-success font-weight-bold mr-2 rdApprove" style="display:none">Approve</label>
                                    <input id="2" asp-for="ApprStatus" value="COMPLETE" class="form-check-input rdComplete" type="radio" onchange="ApprStatus_Change(this)" style="display:none">
                                    <label for="2" class="form-check-label text-success font-weight-bold mr-2 rdComplete" style="display:none">Complete</label>
                                    <input id="4" asp-for="ApprStatus" value="REJECT" class="form-check-input rdReject" type="radio" onchange="ApprStatus_Change(this)" style="display:none">
                                    <label for="4" class="form-check-label text-danger font-weight-bold mr-2 rdReject" style="display:none">Reject</label>
                                    <input id="5" asp-for="ApprStatus" value="REVIEWBACK" class="form-check-input rdRevieBack" type="radio" onchange="ApprStatus_Change(this)" style="display:none">
                                    <label for="5" class="form-check-label text-warning font-weight-bold mr-2 rdRevieBack" style="display:none">Review Back</label>
                                    <input id="7" asp-for="ApprStatus" value="FORWARD" class="form-check-input rdForward" type="radio" onchange="ApprStatus_Change(this)" style="display:none">
                                    <label for="7" class="form-check-label text-secondary font-weight-bold mr-2 rdForward" style="display:none">Forward</label>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div id="divITEngg" class="form-group row" style="display:none">
                                <label class="col-sm-4 col-form-label font-weight-bold">Select IT Engineer<span class="text-danger ml-1">*</span></label>
                                <div class="col-sm-8">
                                    <select asp-for="ITEngineer" class="select2 custom-select w-100" asp-items="@(new SelectList(Model.EmployeeList, "Value", "Text"))">
                                        <option value="">-- Select --</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div id="divRemarks" class="row pt-2" style="display:none">
                        <div class="col-md-8">
                            <div class="row">
                                <label class="col-sm-2 col-form-label font-weight-bold">Remarks</label>
                                <div class="col-sm-10">
                                    <textarea asp-for="Remarks" class="form-control" type="text" rows="3"></textarea>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="row pt-2">
                        <div class="col-md-8">
                            <div class="form-group row">
                                <label class="col-sm-2 col-form-label font-weight-bold"></label>
                                <div class="col-sm-10">
                                    <button id="btnSubmit" type="button" name="submit" value="Submit" class="btn btn-primary btn-sm" style="display:none" onclick="SaveRecord()">Submit</button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

@if (Model.HistoryList != null && Model.HistoryList.Count > 0)
{
    <div class="row">
        <div class="col-md-2"></div>
        <div class="row col-md-8">
            <div class="table-responsive">
                <h3 class="text-info font-weight-bold text-center">Request History</h3>
                <br />
                <table id="dt-hs" class="table w-100 table-bordered table-sm table-hover table-striped nowrap">
                    <thead class="bg-primary-800">
                        <tr>
                            <th width="5%" class="text-center">#</th>
                            <th width="12%">User Type</th>
                            <th width="20%">User Name</th>
                            <th>Remarks</th>
                            <th width="15%">Status</th>
                            <th width="20%">TDate</th>
                        </tr>
                    </thead>
                    <tbody>
                        @foreach (var item in Model.HistoryList)
                        {
                            <tr>
                                <td class="text-center">@item.SrNo</td>
                                <td>@item.UserType</td>
                                <td>@item.EmpName</td>
                                <td>@item.Remarks</td>
                                <td>@item.StatusDescr</td>
                                <td>@item.TDate</td>
                            </tr>
                        }
                    </tbody>
                </table>
            </div>
        </div>
        <div class="col-md-2"></div>
    </div>
    }

@section ScriptsBlock {
    <script src="~/js/formplugins/bootstrap-datepicker/bootstrap-datepicker.js"></script>
    <script type="text/javascript">
    $(document).ready(function () {
        $('.select2').select2();
        runDatePicker();
        FillForm();
    });

    var controls = {
        leftArrow: '<i class="fal fa-angle-left" style="font-size: 1.25rem"></i>',
        rightArrow: '<i class="fal fa-angle-right" style="font-size: 1.25rem"></i>'
    }
    var runDatePicker = function () {
        $('#Date1, #Date2').datepicker({
            todayHighlight: true,
            orientation: "bottom left",
            templates: controls,
            autoclose: true
        });
    }

        function FillForm() {
            $(".rdReqFor").prop("disabled", true);
            $(".rdEmail").prop('disabled', true);
            if ("@Model.IdType" == "EMAILID") {
                $("#div_EmailAccess").show();
            }
            else {
                $("#div_EmailAccess").hide();
            }
            if ("@Mode" == "E") {
            $("#divStatus").show();
            $("#divRemarks").show();
            $("#btnSubmit").show();

            if ($('#ApprType').val() == 'HOD' && $("#Status").val() == 2) {
                $(".rdApprove").show();
                $(".rdReject").show();
                $(".rdRevieBack").show();
            }
            if ($('#ApprType').val() == 'IT_HOD' && $("#Status").val() == 3) {
                $(".rdApprove").show();
                $(".rdReject").show();
                $(".rdRevieBack").show();
            }
            if ($('#ApprType').val() == 'IT_ENGG' && $("#Status").val() == 4) {
                $(".rdComplete").show();
                $(".rdReject").show();
                $(".rdRevieBack").show();
                $(".rdForward").show();
                }
        }
        else {
            $("#divStatus").hide();
            $("#divRemarks").hide();
            $("#btnSubmit").hide();
        }
    }

        function ApprStatus_Change(radio) {
            if ($('#ApprType').val() == 'IT_ENGG') {
                if (radio.value == 'FORWARD') {
                    $("#divITEngg").show();
                }
                else {
                    $('#divITEngg').hide();
                }
            }
        };

    function SaveRecord()
    {
        var requestUrl = 'IT/HDUserCreateApprAdd';
        var reqNo = $('#RequestNo').val();
        var plant = $('#Plant').val();
        var reqId = $('#UserID').val();
        var reqName = $('#EmpName').val();
        var empCode = $('#EmpCode2').val();
        var empName = $('#EmpName2').val();
        var reqFor = $('#ReqFor').val();
        var idType = $('#IdType').val();
        var apprType = $('#ApprType').val();
        var itEngineer = $('#ITEngineer').val();
        var currentApprId = $('#ApprID').val();
        var currentStatus = $('#Status').val();    //Current Status (before click on submit button)
        var apprStatus = $('[name="ApprStatus"]:radio:checked').val();
        var remarks = $('#Remarks').val();

        var bool = 'true';
        if ($('input[name=ApprStatus]:checked').length == 0) {
            bool = 'false';
            Swal.fire("Info!", "Select Status", "error");
        }

        if (apprType == "IT_ENGG" && currentStatus == 4) {

            if (apprStatus == "FORWARD") {
                if (itEngineer == '') {
                    bool = 'false';
                    Swal.fire("Info!", "Select IT Engineer", "error");
                }
                if (itEngineer == currentApprId) {
                    bool = 'false';
                    Swal.fire("Info!", "Select Different IT Engineer", "error");
                }
            }
        }

        if (bool == 'true')
        {
            debugger;
            $.ajax({
                url: requestUrl,
                type: "POST",
                data:
                {
                    iReqNo: reqNo, strPlant: plant, strReqId: reqId, strReqName: reqName, strEmpCode: empCode, strEmpName: empName, strIdType: idType, strReqFor: reqFor,
                    strApprType: apprType, strCurrentApprId: currentApprId, strCurrentApprStatus: apprStatus, strITEngineer: itEngineer, strRemarks: remarks
                },
                success: function (data, status)
                {
                    if (data == '1' || data == '2')
                    {
                        if ('@ViewBag.Login' == 'Y')
                        {
                            Swal.fire("Success", "Request Status Updated Successfully", "success").then(function () { window.location.href = "/IT/HDUserCreateView"; })
                        }
                        else
                        {
                            Swal.fire("Success", "Request Status Updated Successfully", "success").then(function () { window.location.href = "/Account/Index"; })
                        }
                    }
                    else
                    {
                        Swal.fire("Info!", "Something went wrong", "error");
                    }
                },
                error: function ()
                {
                    Swal.fire("Error!", "Encountered Error", "error");
                },
            });
        }
    }

    </script>
}
